# ReorderingSurvey2025

This repository hosts an experimental framework for studying how matrix reordering affects sparse multiplication performance. The high-level design is described in `AGENTS.md`.

## Quick Start

1. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

2. **Run a simple test**:
   ```bash
   python -m pytest tests/test_identity_reorder.py -v
   ```

3. **Run identity reordering on a sample matrix**:
   ```bash
   # Create a test matrix
   mkdir -p /tmp/sample_data
   cat > /tmp/sample_data/test.mtx << 'EOF'
   %%MatrixMarket matrix coordinate real general
   4 4 4
   1 1 1.0
   2 2 2.0
   3 3 3.0
   4 4 4.0
   EOF
   
   # Run reordering
   export RESULTS_DIR=/tmp/results
   bash Programs/Reorder.sbatch /tmp/sample_data/test.mtx identity
   
   # Check results
   ls -la /tmp/results/Reordering/test/identity_default/
   ```

## Repository Layout

- `Raw_Matrices/` – Download location for matrices from the SuiteSparse Matrix Collection
- `Programs/` – Slurm drivers and wrapper scripts for reordering techniques and multiplication kernels
- `Results/` – Output CSVs and permutation files generated by the pipeline
- `scripts/` – Helper utilities for dataset bootstrap and CSV post-processing
- `config/` – YAML files describing available techniques and parameter sets
  - `config/modules/` – Module definitions for different dependency sets
- `logs/` – Slurm job output
- `tests/` – **Comprehensive test suite** with unit, integration, and end-to-end tests
- `docs/` – Documentation including module loading system guide

See `TODO.md` for current development status and `TOOLS.md` for the list of supported algorithms.

## Module Loading System

The framework includes an automatic module loading system that ensures each technique has access to its required dependencies. This system:

- **Automatically loads modules** based on technique requirements
- **Sets environment variables** as needed for each technique
- **Handles multiple environments** (with/without module systems)
- **Provides verification** to ensure dependencies are available

See `docs/MODULE_LOADING.md` for detailed documentation.

## Customizing Data Locations

By default the matrices and experiment results reside under `Raw_Matrices/` and
`Results/` inside the repository.  Large deployments can place these folders
elsewhere by exporting `MATRIX_DIR` and `RESULTS_DIR` before sourcing
`Programs/exp_config.sh`.

## Installing Reordering Techniques

Run `scripts/bootstrap.sh` to fetch external reorderers. Build them after
loading the necessary modules on your cluster. Rabbit Order (`ro`) requires
`g++` (≥ 4.9.2), `Boost` (≥ 1.58.0), `libnuma` (≥ 2.0.9), and
`libtcmalloc_minimal` from `gperftools` (≥ 2.1); see
`Programs/Reordering/Techniques/README.md` for detailed commands.

## Python Environment

Helper scripts such as `csv_helper.py` (GraphBLAS-based) rely on `numpy`, `pandas`,
`python-graphblas`, and `PyMetis`. The scipy versions (`*_scipy.py`) rely on `scipy`
for compatibility. Clusters often forbid `pip` or `sudo`, so
make these packages available via the module system or by building them in a
local prefix.

The `requirements.txt` file enumerates the Python packages that need to be
present; satisfy them using modules or local builds.

## Example Slurm Run

Each driver now handles a single matrix, technique, and parameter set. Submit
multiple jobs to sweep over inputs.

### Reordering

```bash
# Reorder with Rabbit Order in cluster mode
sbatch Programs/Reorder.sbatch Raw_Matrices/TEST/matrix.mtx ro mode=cluster

# Reorder with RCM (symmetric mode)  
sbatch Programs/Reorder.sbatch Raw_Matrices/TEST/matrix.mtx rcm symmetric=true
```

### Multiplication

```bash
# Multiply the reordered matrix with cuSPARSE
sbatch --dependency=afterok:<REORDER_JOBID> \
       Programs/Multiply.sbatch \
       Results/Reordering/matrix/ro_mode-cluster/results.csv \
       cucsrspmm alpha=1.0

# Multiply with mock kernel for testing
sbatch Programs/Multiply.sbatch \
       Results/Reordering/matrix/identity_default/results.csv \
       mock alpha=1.0
```

The `mult_impl` argument selects a wrapper script from
`Programs/Multiplication/Techniques/`.

## Testing

The framework includes a comprehensive test suite with clear organization:

```bash
# Run complete test suite (79 tests, ~75s)
python -m pytest tests/ -v

# Run specific test categories  
python -m pytest tests/unit/ -v         # Unit tests (44 tests, ~30s)
python -m pytest tests/integration/ -v  # Integration tests (21 tests, ~25s)
python -m pytest tests/e2e/ -v          # End-to-end workflows (8 tests, ~15s)

# Run specific test files
python -m pytest tests/test_amd.py -v            # AMD reordering tests
python -m pytest tests/test_unified_cusparse.py -v  # cuSPARSE tests

# Fast development mode (stop on first failure)
python -m pytest tests/ -x -v
```

### Test Status
Current test suite: **79 tests** with **66 passing (83.5%)** in typical environments

#### Expected Test Failures
Some tests may fail due to missing system dependencies (this is normal):
- **AMD tests (3)**: Require `libsuitesparse-dev` system package
- **Rabbit Order test (1)**: Requires building external tool via `scripts/bootstrap_ro.sh`
- **E2E tests (8)**: Currently depend on external test matrices (known issue)
- **GPU tests (1)**: Require CUDA/GPU environment

### Test Categories
- **Unit tests**: Individual component testing (reordering, multiplication, modules)
- **Integration tests**: Component interaction testing  
- **End-to-end tests**: Complete research workflow simulation

See `tests/README.md` for detailed testing documentation and contributor guidelines.
